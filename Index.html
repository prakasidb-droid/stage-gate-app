<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&D Stage-Gate Control (Cloud Version)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js';

        window.Firebase = { 
            initializeApp, getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence, signInAnonymously, signInWithCustomToken,
            getFirestore, doc, setDoc, onSnapshot, collection,
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject 
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #4f46e5; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-indigo-100 selection:text-indigo-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        // --- Firebase Config & Setup ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "", 
                authDomain: "project-timeline-e25e8.firebaseapp.com",
                projectId: "project-timeline-e25e8",
                storageBucket: "project-timeline-e25e8.firebasestorage.app",
                messagingSenderId: "722630495823",
                appId: "1:722630495823:web:68f72f9cd0225066bb243a",
            };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rd-stage-gate-system';
        
        let db, auth, storage;
        if (window.Firebase) {
            try {
                const app = window.Firebase.initializeApp(firebaseConfig);
                auth = window.Firebase.getAuth(app);
                db = window.Firebase.getFirestore(app);
                storage = window.Firebase.getStorage(app);
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }
        }

        // --- ICONS ---
        const IconBase = ({ children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const CheckCircle2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const BarChart3 = (props) => <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const ShieldAlert = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></IconBase>;
        const FlaskConical = (props) => <IconBase {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Flag = (props) => <IconBase {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconBase>;
        const FileCheck = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></IconBase>;
        const Edit = (props) => <IconBase {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const CloudUpload = (props) => <IconBase {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;

        // --- APP ROOT ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedGate, setSelectedGate] = useState(1);
            const [activeProjectId, setActiveProjectId] = useState(null);
            const [user, setUser] = useState(null);
            const [projects, setProjects] = useState([]);
            const [uploadingKey, setUploadingKey] = useState(null); // เก็บ String "ProjectID_GateX_Idx"
            const [isLoading, setIsLoading] = useState(true);

            // Authentication & Sync
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await window.Firebase.signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            if (!auth.currentUser) await window.Firebase.signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth init error:", e); }
                    finally { setIsLoading(false); }
                };
                initAuth();
                const unsubscribe = window.Firebase.onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const docRef = window.Firebase.doc(db, 'artifacts', appId, 'public', 'data', 'projects', 'main');
                const unsubscribe = window.Firebase.onSnapshot(docRef, 
                    (docSnap) => { if (docSnap.exists() && docSnap.data().list) setProjects(docSnap.data().list); },
                    (err) => console.error("Firestore sync error:", err)
                );
                return unsubscribe;
            }, [user]);

            const saveToCloud = async (newProjects) => {
                if (!user || !db) return;
                try {
                    const docRef = window.Firebase.doc(db, 'artifacts', appId, 'public', 'data', 'projects', 'main');
                    await window.Firebase.setDoc(docRef, { list: newProjects });
                } catch (e) { console.error("Save failed:", e); }
            };

            const fileInputRef = useRef(null);
            const [uploadTarget, setUploadTarget] = useState({ gate: null, idx: null });

            const activeProject = projects.find(p => p.id === activeProjectId);

            const handleCreateProject = () => {
                const name = prompt("Project Name:");
                if (!name) return;
                const project = {
                    id: `PRJ-${Date.now()}`, name, type: 'rd', progress: 0, status: 'Gate 1',
                    startDate: new Date().toISOString().split('T')[0],
                    plannedDates: { 1: '', 2: '', 3: '', 4: '' },
                    checklistData: {}, attachments: {}, isVisible: true
                };
                const updated = [...projects, project];
                setProjects(updated);
                saveToCloud(updated);
            };

            const toggleCheck = (gateNum, itemIdx) => {
                const updated = projects.map(p => {
                    if (p.id === activeProjectId) {
                        const key = `gate${gateNum}_${itemIdx}`;
                        const newChecklist = { ...p.checklistData, [key]: !p.checklistData[key] };
                        const checkedCount = Object.values(newChecklist).filter(v => v === true).length;
                        const progress = Math.min(Math.round((checkedCount / 12) * 100), 100);
                        return { ...p, checklistData: newChecklist, progress };
                    }
                    return p;
                });
                setProjects(updated);
                saveToCloud(updated);
            };

            const triggerFileUpload = (gateNum, itemIdx) => {
                setUploadTarget({ gate: gateNum, idx: itemIdx });
                if (fileInputRef.current) { fileInputRef.current.value = ""; fileInputRef.current.click(); }
            };

            const handleFileSelected = (e) => {
                const file = e.target.files[0];
                if (file && activeProjectId && uploadTarget.gate !== null) {
                    const target = { ...uploadTarget };
                    const pid = activeProjectId;
                    const specificKey = `${pid}_gate${target.gate}_${target.idx}`;
                    
                    setUploadingKey(specificKey); // ระบุ Key ที่กำลังอัปโหลดให้ชัดเจน

                    const storageRef = window.Firebase.ref(storage, `artifacts/${appId}/public/data/attachments/${pid}/${Date.now()}_${file.name}`);
                    
                    window.Firebase.uploadBytes(storageRef, file).then((snapshot) => {
                        return window.Firebase.getDownloadURL(snapshot.ref);
                    }).then((downloadURL) => {
                        const fileData = { name: file.name, url: downloadURL };
                        const dbKey = `gate${target.gate}_${target.idx}`;
                        
                        const updated = projects.map(p => p.id === pid ? { ...p, attachments: { ...p.attachments, [dbKey]: fileData } } : p);
                        setProjects(updated);
                        saveToCloud(updated);
                        setUploadingKey(null);
                    }).catch((error) => {
                        console.error("Upload failed", error);
                        setUploadingKey(null);
                        alert("Upload failed: " + error.message);
                    });
                }
            };

            const gateData = {
                1: { title: "Gate 1: Concept Approval", items: ["Project Charter", "Strategic Alignment", "Technical Feasibility", "Initial Regulatory Check"] },
                2: { title: "Gate 2: Lab Feasibility", items: ["Lab Report / Formula Card", "Supplier Selection", "Initial Stability", "Performance Evaluation"] },
                3: { title: "Gate 3: Customer Trial", items: ["Final Product Spec", "SDS / TDS Ready", "Customer Risk Assessment", "Trial Protocol Approval"] },
                4: { title: "Gate 4: Commercial Launch", items: ["Scale-up Report", "P&L Analysis", "QA/QC Process Approval", "Commercial Readiness"] }
            };

            const Sidebar = () => (
                <div className="w-64 bg-slate-900 text-white h-screen fixed left-0 top-0 p-4 border-r border-slate-800 z-10 flex flex-col">
                    <div className="flex items-center gap-2 mb-10 px-2"><div className="bg-indigo-500 p-2 rounded-lg"><FlaskConical size={24} /></div><span className="font-bold text-xl italic uppercase">R&D Matrix</span></div>
                    <nav className="space-y-1 flex-1">
                        <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'dashboard' ? 'bg-indigo-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'}`}><BarChart3 size={20} /> Dashboard</button>
                        <button onClick={() => activeProjectId && setActiveTab('checklist')} disabled={!activeProjectId} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'checklist' ? 'bg-indigo-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'} ${!activeProjectId ? 'opacity-30' : ''}`}><CheckCircle2 size={20} /> Gate Checklist</button>
                    </nav>
                    <div className="pt-4 border-t border-slate-800">
                        <button onClick={() => window.Firebase.signOut(auth)} className="w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-red-900/20 text-red-400 text-xs"><LogOut size={14} /> Sign Out</button>
                    </div>
                </div>
            );

            const Dashboard = () => (
                <div className="space-y-6 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center">
                        <div><h2 className="text-2xl font-black text-slate-800 italic uppercase">Overview</h2><p className="text-slate-500 text-sm">Innovation Project Tracking</p></div>
                        <button onClick={handleCreateProject} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-black flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-lg uppercase tracking-widest text-sm italic"><Plus size={20} /> New Project</button>
                    </div>
                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 text-slate-500 text-[10px] uppercase font-black tracking-widest border-b"><tr><th className="px-6 py-4">Project Name</th><th className="px-6 py-4">Status</th><th className="px-6 py-4">Progress</th><th className="px-6 py-4 text-right">Action</th></tr></thead>
                            <tbody className="divide-y divide-slate-50">
                                {projects.map(p => (
                                    <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-6 py-5 font-black text-slate-900 italic">{p.name}</td>
                                        <td className="px-6 py-5"><span className="text-xs font-bold px-2 py-1 bg-indigo-50 text-indigo-600 rounded-md uppercase">{p.status}</span></td>
                                        <td className="px-6 py-5"><div className="w-24 bg-slate-100 rounded-full h-1.5"><div className="bg-indigo-600 h-1.5 rounded-full transition-all" style={{ width: `${p.progress}%` }}></div></div></td>
                                        <td className="px-6 py-5 text-right"><button onClick={() => { setActiveProjectId(p.id); setActiveTab('checklist'); }} className="text-indigo-600 font-black text-xs uppercase italic bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-all">Manage</button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            const ChecklistView = () => {
                if (!activeProject) return null;
                return (
                    <div className="max-w-4xl mx-auto space-y-6 pb-20 animate-in slide-in-from-right-4 duration-500">
                        <div className="flex justify-between items-center bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                            <div className="flex items-center gap-4"><div className="p-3 bg-indigo-50 rounded-xl text-indigo-600 shadow-inner"><FlaskConical size={24} /></div><div><h2 className="text-xl font-black text-slate-900 italic uppercase">{activeProject.name}</h2><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{activeProject.id}</p></div></div>
                            <button onClick={() => setActiveTab('dashboard')} className="text-slate-400 hover:text-slate-600 text-[10px] font-black uppercase italic flex items-center gap-1 transition-colors"><X size={14} /> Close Project</button>
                        </div>
                        <div className="flex gap-2">
                            {[1, 2, 3, 4].map(num => (
                                <button key={num} onClick={() => setSelectedGate(num)} className={`flex-1 p-4 rounded-xl border-2 transition-all text-left group ${selectedGate === num ? 'border-indigo-600 bg-white shadow-xl -translate-y-1' : 'border-slate-100 bg-slate-50 hover:bg-white hover:border-slate-200'}`}>
                                    <div className={`text-[9px] font-black uppercase mb-1 ${selectedGate === num ? 'text-indigo-600' : 'text-slate-400'}`}>Gate {num}</div>
                                    <div className={`text-xs font-black uppercase italic leading-tight ${selectedGate === num ? 'text-slate-900' : 'text-slate-500'}`}>{gateData[num].title.split(':')[1]}</div>
                                </button>
                            ))}
                        </div>
                        <div className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
                            <div className="p-8 border-b border-slate-100 bg-white flex justify-between items-center"><div><h3 className="text-2xl font-black text-slate-900 italic tracking-tighter uppercase">{gateData[selectedGate].title}</h3></div></div>
                            <table className="w-full text-left">
                                <thead className="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-black tracking-widest border-b"><tr><th className="px-8 py-4 w-12 text-center">Status</th><th className="px-4 py-4">Requirement</th><th className="px-4 py-4 w-72">Evidence</th><th className="px-6 py-4 w-24 text-center">Attach</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {gateData[selectedGate].items.map((itemLabel, idx) => {
                                        const dbKey = `gate${selectedGate}_${idx}`;
                                        const specificItemKey = `${activeProject.id}_gate${selectedGate}_${idx}`; // Key ที่ใช้เช็คเฉพาะเจาะจง
                                        const isChecked = activeProject.checklistData?.[dbKey] || false;
                                        const attachment = activeProject.attachments?.[dbKey];
                                        const isThisItemUploading = uploadingKey === specificItemKey;

                                        return (
                                            <tr key={idx} className={`group hover:bg-indigo-50/30 transition-all ${isChecked ? 'opacity-60' : ''}`}>
                                                <td className="px-8 py-6 text-center"><input type="checkbox" checked={isChecked} onChange={() => toggleCheck(selectedGate, idx)} className="w-6 h-6 rounded-lg border-2 border-slate-200 text-indigo-600 focus:ring-indigo-500 cursor-pointer transition-all hover:scale-110" /></td>
                                                <td className="px-4 py-6 font-bold text-slate-800 italic">{itemLabel}</td>
                                                <td className="px-4 py-6">
                                                    {attachment ? (
                                                        <a href={attachment.url} target="_blank" className="flex items-center gap-2 text-indigo-600 hover:underline text-xs font-bold">
                                                            <FileCheck size={16}/> {attachment.name.length > 20 ? attachment.name.substring(0, 17) + '...' : attachment.name} <ExternalLink size={10}/>
                                                        </a>
                                                    ) : (
                                                        <div className="text-slate-300 text-xs italic font-medium flex items-center gap-2"><FileText size={16}/> Evidence Required</div>
                                                    )}
                                                </td>
                                                <td className="px-6 py-6 text-center">
                                                    <button onClick={() => triggerFileUpload(selectedGate, idx)} disabled={isThisItemUploading} className="text-slate-300 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-indigo-50 disabled:opacity-50">
                                                        {isThisItemUploading ? <div className="loader"></div> : <CloudUpload size={20} />}
                                                    </button>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            if (isLoading) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50 flex selection:bg-indigo-100">
                    <Sidebar />
                    <main className="flex-1 ml-64 p-10">
                        <header className="mb-12 flex justify-between items-end">
                            <div><h1 className="text-4xl font-black text-slate-900 tracking-tighter italic uppercase leading-none">Stage-Gate Control</h1><p className="text-slate-400 font-bold mt-2 uppercase text-[10px] tracking-widest italic">Innovation Management System</p></div>
                            <div className="flex items-center gap-3 bg-white px-4 py-2 rounded-2xl border border-slate-200 shadow-sm"><div className="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-black text-xs shadow-inner">BZ</div><div className="text-sm font-black text-slate-800 leading-none italic">{user?.isAnonymous ? 'Guest' : user?.email?.split('@')[0]}</div></div>
                        </header>
                        {activeTab === 'dashboard' ? <Dashboard /> : <ChecklistView />}
                    </main>
                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileSelected} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
