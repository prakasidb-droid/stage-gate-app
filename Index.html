<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R&D Stage-Gate Control (Cloud Version)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, collection } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        window.Firebase = { initializeApp, getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection };
    </script>

    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        html { scroll-behavior: smooth; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-indigo-100 selection:text-indigo-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        // --- Firebase Config & Setup ---
        // Config ของคุณ (จาก project-timeline-e25e8)
        const firebaseConfig = {
            apiKey: "AIzaSyAvcnSqaqsB91MZ62fwV9kufUiDd3mkRao",
            authDomain: "project-timeline-e25e8.firebaseapp.com",
            projectId: "project-timeline-e25e8",
            storageBucket: "project-timeline-e25e8.firebasestorage.app",
            messagingSenderId: "722630495823",
            appId: "1:722630495823:web:68f72f9cd0225066bb243a",
            measurementId: "G-7RCD2PHJV1"
        };

        const appId = 'rd-stage-gate-system';
        
        let db, auth;
        if (window.Firebase) {
            try {
                const app = window.Firebase.initializeApp(firebaseConfig);
                auth = window.Firebase.getAuth(app);
                db = window.Firebase.getFirestore(app);
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }
        }

        // --- ICONS ---
        const IconBase = ({ children, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const CheckCircle2 = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const BarChart3 = (props) => <IconBase {...props}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const ArrowRight = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const Paperclip = (props) => <IconBase {...props}><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const ShieldAlert = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/></IconBase>;
        const FlaskConical = (props) => <IconBase {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Clock = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;
        const Flag = (props) => <IconBase {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></IconBase>;
        const FileCheck = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 15 2 2 4-4"/></IconBase>;
        const Edit = (props) => <IconBase {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>;
        const CalendarDays = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></IconBase>;
        const PlayCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></IconBase>;
        const PauseCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></IconBase>;
        const StopCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Eye = (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (props) => <IconBase {...props}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;

        // --- LOGIN COMPONENT ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    await window.Firebase.signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    console.error(err);
                    setError('Login Failed: ' + err.code);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900 z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-100 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 text-indigo-600">
                                <FlaskConical size={32} />
                            </div>
                            <h1 className="text-2xl font-black text-slate-900 tracking-tight">R&D MATRIX</h1>
                            <p className="text-slate-500 text-sm mt-1">Innovation Stage-Gate Control</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                                <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none font-bold" placeholder="name@example.com" required />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none font-bold" placeholder="••••••••" required />
                            </div>
                            {error && <div className="text-red-500 text-xs font-bold bg-red-50 p-3 rounded-lg flex items-center gap-2"><AlertTriangle size={14}/> {error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-black uppercase tracking-widest hover:bg-indigo-700 transition-all disabled:opacity-50">
                                {loading ? 'Signing In...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- COMPONENTS ---
        const TimelineAdjustmentModal = ({ isOpen, onClose, project, onUpdate }) => {
            const [selectedGate, setSelectedGate] = useState(1);
            const [newDate, setNewDate] = useState('');
            const [newName, setNewName] = useState('');
            const [reason, setReason] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                if (project) {
                    setNewName(project.name || '');
                    if (project.plannedDates) setNewDate(project.plannedDates[selectedGate] || '');
                }
                setReason('');
                setError('');
            }, [isOpen, selectedGate, project]);

            if (!isOpen || !project) return null;

            const handleSave = () => {
                if (!newName.trim()) { setError('กรุณาระบุชื่อโครงการ'); return; }
                if (!newDate) { setError('กรุณาเลือกวันที่ใหม่'); return; }
                if (!reason.trim()) { setError('กรุณาระบุเหตุผลในการแก้ไข'); return; }
                onUpdate(project.id, selectedGate, newDate, reason, newName);
                onClose();
            };

            const formatDate = (dateStr) => {
                if(!dateStr) return '-';
                return new Date(dateStr).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
            };

            const logs = project.dateLogs || [];

            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl animate-in zoom-in-95 duration-200 overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-6 pb-4 flex justify-between items-center border-b border-slate-100">
                            <h3 className="text-xl font-black text-slate-900 tracking-tight flex items-center gap-2"><CalendarDays size={20} className="text-indigo-600"/> Adjust Project Details</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 transition-colors"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="space-y-6">
                                <div>
                                    <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block italic">Project Name</label>
                                    <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)} className="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-500 focus:outline-none font-bold text-slate-800 transition-all" placeholder="Project Name" />
                                </div>
                                <div className="pt-2 border-t border-slate-50">
                                    <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-3 block italic">Select Gate to Reschedule</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {[1, 2, 3, 4].map(g => (
                                            <button key={g} onClick={() => setSelectedGate(g)} className={`py-2 px-1 rounded-lg text-[10px] font-black uppercase border-2 transition-all ${selectedGate === g ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'border-slate-100 text-slate-400 hover:border-slate-200 bg-slate-50'}`}>Gate {g}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <div className="flex justify-between items-end mb-3">
                                        <div><div className="text-[10px] font-bold text-slate-400 uppercase">Current Target</div><div className="text-sm font-bold text-slate-600">{formatDate(project.plannedDates[selectedGate])}</div></div>
                                        <ArrowRight size={16} className="text-slate-300 mb-1" />
                                        <div className="text-right"><label className="text-[10px] font-bold text-indigo-600 uppercase mb-1 block">New Target Date</label><input type="date" value={newDate} onChange={(e) => setNewDate(e.target.value)} className="px-3 py-1.5 rounded-lg border-2 border-indigo-100 focus:border-indigo-500 focus:outline-none text-sm font-bold text-slate-800" /></div>
                                    </div>
                                    <div><label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block flex items-center gap-1 italic">Reason for Change <span className="text-red-500">*</span></label><textarea value={reason} onChange={(e) => setReason(e.target.value)} placeholder="ระบุสาเหตุที่ต้องเลื่อนแผนงาน..." className="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-indigo-500 focus:outline-none text-sm min-h-[80px]" /></div>
                                    {error && <p className="text-xs font-bold text-red-500 mt-2 flex items-center gap-1"><AlertTriangle size={12}/> {error}</p>}
                                </div>
                                <button onClick={handleSave} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 uppercase tracking-widest">Update & Reschedule</button>
                            </div>
                            <div className="mt-8">
                                <h4 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2 italic"><History size={14} /> Audit Log</h4>
                                {logs.length === 0 ? (<div className="text-center py-4 text-xs text-slate-400 italic bg-slate-50 rounded-xl border border-dashed border-slate-200">No changes recorded yet.</div>) : (
                                    <div className="space-y-3">{logs.slice().reverse().map((log, idx) => (<div key={idx} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm text-xs relative pl-4 overflow-hidden"><div className="absolute left-0 top-0 bottom-0 w-1 bg-amber-400"></div><div className="flex justify-between items-start mb-1"><span className="font-bold text-indigo-900">Gate {log.gate} Rescheduled</span><span className="text-[10px] text-slate-400">{new Date(log.timestamp).toLocaleString('th-TH')}</span></div><div className="flex items-center gap-2 text-slate-500 mb-1.5"><span className="line-through decoration-red-400">{formatDate(log.oldDate)}</span><ArrowRight size={10} /><span className="font-bold text-green-600">{formatDate(log.newDate)}</span></div><div className="text-slate-600 bg-slate-50 p-2 rounded-lg italic">"{log.reason}"</div><div className="text-[9px] text-slate-300 mt-1 text-right">by {log.user || 'Admin'}</div></div>))}</div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const NewProjectModal = ({ isOpen, onClose, newProject, setNewProject, onCreate }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-lg rounded-3xl shadow-2xl animate-in zoom-in-95 duration-200 overflow-hidden max-h-[90vh] overflow-y-auto">
                        <div className="p-8 pb-4 flex justify-between items-center sticky top-0 bg-white z-10"><h3 className="text-2xl font-black text-slate-900 tracking-tighter uppercase italic">Launch New Project</h3><button onClick={onClose} className="text-slate-400 hover:text-slate-600"><X size={24} /></button></div>
                        <div className="p-8 pt-2 space-y-5">
                            <div><label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">Project Name</label><input autoFocus type="text" placeholder="e.g. New Solvent Base 2024" value={newProject.name} onChange={(e) => setNewProject({...newProject, name: e.target.value})} className="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-500 focus:outline-none font-bold text-slate-800 transition-all" /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">Start Date</label><input type="date" value={newProject.startDate} onChange={(e) => setNewProject({...newProject, startDate: e.target.value})} className="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-500 focus:outline-none font-bold text-slate-800 transition-all" /></div>
                                <div><label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">Owner</label><input type="text" placeholder="Full Name" value={newProject.owner} onChange={(e) => setNewProject({...newProject, owner: e.target.value})} className="w-full px-4 py-3 rounded-xl border-2 border-slate-100 focus:border-indigo-500 focus:outline-none font-bold text-slate-800 transition-all" /></div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-3">
                                <h4 className="text-xs font-bold text-indigo-600 uppercase tracking-widest mb-2 flex items-center gap-2"><Clock size={12} /> Target Completion Dates</h4>
                                <div className="grid grid-cols-2 gap-3">
                                    {[1, 2, 3, 4].map(g => (<div key={g}><label className="text-[9px] font-bold text-slate-400 mb-1 block">Gate {g}: Target Date</label><input type="date" value={newProject[`gate${g}Date`]} onChange={(e) => setNewProject({...newProject, [`gate${g}Date`]: e.target.value})} className="w-full px-3 py-2 rounded-lg border border-slate-200 text-xs font-bold" /></div>))}
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-2 block">Development Track</label>
                                <div className="grid grid-cols-3 gap-2">{['rd', 'sourcing', 'both'].map(type => (<button key={type} onClick={() => setNewProject({...newProject, type})} className={`py-2 px-1 rounded-lg text-[10px] font-black uppercase border-2 transition-all ${newProject.type === type ? 'bg-indigo-600 border-indigo-600 text-white shadow-md' : 'border-slate-100 text-slate-400 hover:border-slate-200'}`}>{type === 'rd' ? 'R&D Route' : type === 'sourcing' ? 'Sourcing' : 'Combined'}</button>))}</div>
                            </div>
                            <button onClick={onCreate} disabled={!newProject.name} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest mt-2 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed shadow-xl shadow-indigo-100 transition-all active:scale-[0.98]">Create Project Instance</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENT: APP ROOT ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedGate, setSelectedGate] = useState(1);
            const [activeProjectId, setActiveProjectId] = useState(null);
            const [showNewProjectModal, setShowNewProjectModal] = useState(false);
            const [showTimelineAdjust, setShowTimelineAdjust] = useState(false);
            const [showHidden, setShowHidden] = useState(true);
            const [user, setUser] = useState(null);
            const [projects, setProjects] = useState([]);
            
            // --- FIREBASE AUTH & DATA SYNC ---
            useEffect(() => {
                if (!auth) return;
                return window.Firebase.onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const docRef = window.Firebase.doc(db, 'artifacts', appId, 'public', 'data', 'projects', 'main');
                const unsubscribe = window.Firebase.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if(data.list) setProjects(data.list);
                    }
                }, (err) => console.error("Firestore sync error:", err));
                return unsubscribe;
            }, [user]);

            const saveToCloud = async (newProjects) => {
                if (!user || !db) return;
                try {
                    const docRef = window.Firebase.doc(db, 'artifacts', appId, 'public', 'data', 'projects', 'main');
                    await window.Firebase.setDoc(docRef, { list: newProjects });
                } catch (e) {
                    console.error("Save failed:", e);
                    alert("บันทึกไม่สำเร็จ: ข้อมูลอาจมีขนาดใหญ่เกินไป (Firestore Limit 1MB) กรุณาลดขนาดไฟล์แนบ");
                }
            };

            const fileInputRef = useRef(null);
            const jsonImportRef = useRef(null);
            const [uploadTarget, setUploadTarget] = useState({ gate: null, idx: null });
            
            const [newProject, setNewProject] = useState({
                name: '', type: 'rd', owner: '', startDate: new Date().toISOString().split('T')[0],
                gate1Date: '', gate2Date: '', gate3Date: '', gate4Date: '', projectStatus: 'Active'
            });

            useEffect(() => {
                if (newProject.startDate && !newProject.gate1Date) {
                    const start = new Date(newProject.startDate);
                    const addDays = (d, n) => { const res = new Date(d); res.setDate(res.getDate() + n); return res.toISOString().split('T')[0]; };
                    setNewProject(prev => ({ ...prev, gate1Date: addDays(start, 14), gate2Date: addDays(start, 45), gate3Date: addDays(start, 90), gate4Date: addDays(start, 120) }));
                }
            }, [newProject.startDate]);

            const activeProject = projects.find(p => p.id === activeProjectId);

            const handleCreateProject = () => {
                if (!newProject.name) return;
                const project = {
                    ...newProject,
                    id: `PRJ-${Date.now()}`,
                    status: 'Gate 1', progress: 0, createdAt: new Date().toLocaleDateString('th-TH'),
                    plannedDates: { 1: newProject.gate1Date, 2: newProject.gate2Date, 3: newProject.gate3Date, 4: newProject.gate4Date },
                    checklistData: {}, attachments: {}, dateLogs: [], isVisible: true
                };
                const updated = [...projects, project];
                setProjects(updated);
                saveToCloud(updated);
                setNewProject({ name: '', type: 'rd', owner: '', startDate: new Date().toISOString().split('T')[0], gate1Date: '', gate2Date: '', gate3Date: '', gate4Date: '', projectStatus: 'Active' });
                setShowNewProjectModal(false);
            };

            const updateProjectStatus = (id, status) => {
                const updated = projects.map(p => p.id === id ? { ...p, projectStatus: status } : p);
                setProjects(updated);
                saveToCloud(updated);
            };

            const toggleProjectVisibility = (id) => {
                const updated = projects.map(p => p.id === id ? { ...p, isVisible: p.isVisible === false ? true : false } : p);
                setProjects(updated);
                saveToCloud(updated);
            };

            const handleUpdateTimeline = (projectId, gateNum, newDate, reason, newName) => {
                const updated = projects.map(p => {
                    if (p.id === projectId) {
                        const oldDate = p.plannedDates[gateNum];
                        const dateChanged = oldDate !== newDate;
                        let newLogs = p.dateLogs || [];
                        if (dateChanged) newLogs = [...newLogs, { timestamp: new Date().toISOString(), gate: gateNum, oldDate, newDate, reason, user: user.email || 'Admin' }];
                        return { ...p, name: newName, plannedDates: { ...p.plannedDates, [gateNum]: newDate }, dateLogs: newLogs };
                    }
                    return p;
                });
                setProjects(updated);
                saveToCloud(updated);
            };

            const toggleCheck = (gateNum, itemIdx) => {
                if (!activeProjectId) return;
                const updated = projects.map(p => {
                    if (p.id === activeProjectId) {
                        const key = `gate${gateNum}_${itemIdx}`;
                        const newChecklist = { ...p.checklistData, [key]: !p.checklistData[key] };
                        const checkedCount = Object.values(newChecklist).filter(v => v === true).length;
                        const progress = Math.min(Math.round((checkedCount / 20) * 100), 100);
                        let status = p.status;
                        if (checkedCount > 5) status = 'Gate 2'; if (checkedCount > 10) status = 'Gate 3'; if (checkedCount > 16) status = 'Gate 4';
                        return { ...p, checklistData: newChecklist, progress, status };
                    }
                    return p;
                });
                setProjects(updated);
                saveToCloud(updated);
            };

            const triggerFileUpload = (gateNum, itemIdx) => {
                setUploadTarget({ gate: gateNum, idx: itemIdx });
                if (fileInputRef.current) { fileInputRef.current.value = ""; fileInputRef.current.click(); }
            };

            const handleFileSelected = (e) => {
                if (e.target.files && e.target.files[0] && activeProjectId) {
                    const file = e.target.files[0];
                    // Firestore Document Limit is 1MB. Setting limit to 800KB for safety.
                    if (file.size > 800 * 1024) { alert("File too large for Cloud Sync: เนื่องจาก Firestore จำกัดขนาดข้อมูล กรุณาแนบไฟล์ไม่เกิน 800KB"); return; }
                    const reader = new FileReader();
                    const target = { ...uploadTarget };
                    const pid = activeProjectId;
                    reader.onload = (event) => {
                        const fileData = { name: file.name, url: event.target.result, type: file.type, size: file.size, lastModified: file.lastModified };
                        const key = `gate${target.gate}_${target.idx}`;
                        const updated = projects.map(p => p.id === pid ? { ...p, attachments: { ...p.attachments, [key]: fileData } } : p);
                        setProjects(updated);
                        saveToCloud(updated);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleRemoveFile = (gateNum, itemIdx) => {
                const updated = projects.map(p => {
                    if (p.id === activeProjectId) {
                        const newAttachments = { ...p.attachments };
                        delete newAttachments[`gate${gateNum}_${itemIdx}`];
                        return { ...p, attachments: newAttachments };
                    }
                    return p;
                });
                setProjects(updated);
                saveToCloud(updated);
            };

            const handleExportData = () => {
                const blob = new Blob([JSON.stringify(projects, null, 2)], { type: "application/json" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `StageGate_CloudBackup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const triggerImportData = () => jsonImportRef.current && jsonImportRef.current.click();
            const handleImportData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data)) {
                            setProjects(data);
                            saveToCloud(data);
                        }
                    } catch (err) { alert("Error parsing JSON file."); }
                };
                reader.readAsText(file);
            };

            // --- DATA STRUCTURE ---
            const gateData = {
                1: { title: "Gate 1: Concept & Direction Approval", desc: "อนุมัติแนวคิดและทิศทางโครงการ", items: [
                    { label: "วัตถุประสงค์โครงการชัดเจน (Problem/Opportunity)", doc: "Project Charter / Market Study", type: "all" },
                    { label: "สอดคล้องกับทิศทางบริษัท (ESG/Safety/Innovation)", doc: "Strategic Alignment Memo", type: "all" },
                    { label: "ความเป็นไปได้ทางเทคนิคเบื้องต้น (Technical Feasibility)", doc: "Technical Concept Note", type: "rd" },
                    { label: "การสำรวจศักยภาพของ Supplier เบื้องต้น", doc: "Supplier Landscape Report", type: "sourcing" },
                    { label: "ตรวจสอบกฎหมายและสารต้องห้ามเบื้องต้น", doc: "Regulatory Compliance Check", type: "all" }
                ]},
                2: { title: "Gate 2: Lab Feasibility & Selection", desc: "พิสูจน์ได้ในห้องปฏิบัติการหรือการคัดเลือกเบื้องต้น", items: [
                    { label: "สูตร/เทคนิค สามารถทำซ้ำได้ใน Lab (Repeatability)", doc: "Lab Report / Formula Card", type: "rd" },
                    { label: "ตัวอย่างจาก Supplier ผ่านการทดสอบเบื้องต้น", doc: "Initial Test Result / COA", type: "sourcing" },
                    { label: "ประสิทธิภาพหลัก (Performance) ผ่านเกณฑ์", doc: "Performance Evaluation Report", type: "all" },
                    { label: "วัตถุดิบมีแหล่งจัดหาและราคาเบื้องต้นได้", doc: "Raw Material List / Quotation", type: "all" },
                    { label: "ความเสถียร (Stability) อยู่ในระดับที่ยอมรับได้", doc: "Accelerated Stability Report", type: "all" }
                ]},
                3: { title: "Gate 3: Ready for Customer Trial", desc: "พร้อมทดสอบลูกค้า (จุดควบคุมสูงสุด)", items: [
                    { label: "สูตรนิ่งและสเปกผลิตภัณฑ์ชัดเจน (Final Spec)", doc: "Finished Goods Specification", type: "all" },
                    { label: "เอกสารทางเทคนิคพร้อมใช้งาน (SDS/TDS)", doc: "SDS / TDS Files", type: "all" },
                    { label: "Risk Assessment สำหรับการทดสอบที่ลูกค้า", doc: "Customer Risk Assessment Form", type: "all", highlight: true },
                    { label: "ประมาณการต้นทุนรวม (Landed Cost / COGS)", doc: "Costing Sheet", type: "all" },
                    { label: "แผนการทดสอบที่ลูกค้า (Site/Condition/KPI)", doc: "Trial Protocol / Plan", type: "all" },
                    { label: "ฝ่ายขายและ BU เซ็นรับทราบและเห็นชอบ", doc: "Trial Approval Form (Sales/BU Signed)", type: "all" }
                ]},
                4: { title: "Gate 4: Commercial & Scale-up", desc: "พร้อมเชิงพาณิชย์และการขยายการผลิต", items: [
                    { label: "ผลการทดสอบลูกค้าผ่านตามเกณฑ์ (Validation)", doc: "Customer Feedback / Trial Report", type: "all" },
                    { label: "สามารถผลิตจริงหรือนำเข้าปริมาณมากได้ (Scale-up)", doc: "Scale-up Report / Capacity Plan", type: "all" },
                    { label: "กำไร (Margin) และราคาสอดคล้องกับเป้าหมาย", doc: "P&L Analysis Report", type: "all" },
                    { label: "QA/QC รับรองกระบวนการตรวจรับและจัดเก็บ", doc: "Quality Control Plan (QCP)", type: "all" },
                    { label: "เอกสารเชิงพาณิชย์และระบบฐานข้อมูลสินค้าครบ", doc: "Commercial Readiness Checklist", type: "all" }
                ]}
            };

            const Sidebar = () => (
                <div className="w-64 bg-slate-900 text-white h-screen fixed left-0 top-0 p-4 border-r border-slate-800 z-10 flex flex-col">
                    <div className="flex items-center gap-2 mb-10 px-2"><div className="bg-indigo-500 p-2 rounded-lg"><FlaskConical size={24} /></div><span className="font-bold text-xl tracking-tight uppercase italic">R&D Matrix</span></div>
                    <nav className="space-y-1 flex-1">
                        <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'dashboard' ? 'bg-indigo-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'}`}><BarChart3 size={20} /> Project Dashboard</button>
                        <button onClick={() => { activeProjectId && setActiveTab('checklist') }} disabled={!activeProjectId} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'checklist' ? 'bg-indigo-600 shadow-lg' : 'hover:bg-slate-800 text-slate-400'} ${!activeProjectId ? 'opacity-50' : ''}`}><CheckCircle2 size={20} /> Gate Checklist</button>
                    </nav>
                    <div className="pt-4 border-t border-slate-800 space-y-1">
                        <button onClick={handleExportData} className="w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-slate-800 text-slate-400 text-xs"><Download size={14} /> Backup Data</button>
                        <button onClick={triggerImportData} className="w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-slate-800 text-slate-400 text-xs"><Upload size={14} /> Restore Data</button>
                        {user && <button onClick={() => window.Firebase.signOut(auth)} className="w-full flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-red-900/20 text-red-400 text-xs mt-4"><LogOut size={14} /> Sign Out ({user.email})</button>}
                    </div>
                </div>
            );

            const Dashboard = () => {
                const filteredProjects = projects.filter(p => showHidden ? true : p.isVisible !== false);
                return (
                    <div className="space-y-6 animate-in fade-in duration-500">
                        <div className="flex justify-between items-center">
                            <div><h2 className="text-2xl font-bold text-slate-800 tracking-tight">Project Overview</h2><p className="text-slate-500 text-sm">จัดการและติดตามสถานะโครงการทั้งหมด (Cloud Sync)</p></div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowHidden(!showHidden)} className={`px-4 py-2.5 rounded-xl font-bold flex items-center gap-2 border-2 transition-all text-xs uppercase tracking-widest ${showHidden ? 'bg-white border-slate-200 text-slate-600 hover:bg-slate-50' : 'bg-indigo-50 border-indigo-200 text-indigo-600'}`}>{showHidden ? <Eye size={18}/> : <EyeOff size={18}/>} {showHidden ? 'All Projects' : 'Visible Only'}</button>
                                <button onClick={() => setShowNewProjectModal(true)} className="bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-md"><Plus size={20} /> New Project</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm"><p className="text-slate-400 text-xs font-bold uppercase">Active Projects</p><p className="text-3xl font-black text-slate-900 mt-2">{projects.filter(p => (p.projectStatus || 'Active') === 'Active').length}</p></div>
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-amber-500"><p className="text-slate-400 text-xs font-bold uppercase">Avg. Progress</p><p className="text-3xl font-black text-slate-900 mt-2">{projects.length > 0 ? Math.round(projects.reduce((a, b) => a + b.progress, 0) / projects.length) : 0}%</p></div>
                            <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-indigo-500"><p className="text-slate-400 text-xs font-bold uppercase">Status</p><p className="text-3xl font-black text-green-500 mt-2">Ready</p></div>
                        </div>
                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
                            <table className="w-full text-left">
                                <thead className="bg-slate-50 text-slate-500 text-[10px] uppercase font-bold tracking-widest border-b"><tr><th className="px-6 py-4">Visibility</th><th className="px-6 py-4">Project Details</th><th className="px-6 py-4">Status</th><th className="px-6 py-4">Launch</th><th className="px-6 py-4">Stage</th><th className="px-6 py-4">Progress</th><th className="px-6 py-4 text-right">Action</th></tr></thead>
                                <tbody className="divide-y divide-slate-50">
                                    {filteredProjects.map((p) => (
                                        <tr key={p.id} className={`hover:bg-slate-50/80 transition-colors ${activeProjectId === p.id ? 'bg-indigo-50/40' : ''} ${p.isVisible === false ? 'opacity-50 grayscale' : ''}`}>
                                            <td className="px-6 py-5"><button onClick={() => toggleProjectVisibility(p.id)} className={`p-2 rounded-lg transition-all ${p.isVisible !== false ? 'bg-indigo-50 text-indigo-600' : 'bg-slate-100 text-slate-400'}`}>{p.isVisible !== false ? <Eye size={18} /> : <EyeOff size={18} />}</button></td>
                                            <td className="px-6 py-5"><div className="font-bold text-slate-900">{p.name}</div><div className="text-[10px] text-slate-400 uppercase">{p.id}</div></td>
                                            <td className="px-6 py-5"><div className="relative w-32"><select value={p.projectStatus || 'Active'} onChange={(e) => updateProjectStatus(p.id, e.target.value)} className={`appearance-none pl-8 pr-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-wider border-2 w-full cursor-pointer ${(p.projectStatus === 'Active' || !p.projectStatus) ? 'bg-green-50 text-green-700 border-green-200' : p.projectStatus === 'Pending' ? 'bg-amber-50 text-amber-700 border-amber-200' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><option value="Active">Active</option><option value="Pending">Pending</option><option value="Cancel">Cancel</option></select><div className="absolute left-2.5 top-1/2 -translate-y-1/2 pointer-events-none">{(p.projectStatus === 'Active' || !p.projectStatus) && <PlayCircle size={12} className="text-green-600" />}{p.projectStatus === 'Pending' && <PauseCircle size={12} className="text-amber-600" />}{p.projectStatus === 'Cancel' && <StopCircle size={12} className="text-slate-400" />}</div></div></td>
                                            <td className="px-6 py-5"><div className="text-xs font-bold text-slate-700 flex items-center gap-1"><Flag size={12} className="text-indigo-500" />{new Date(p.plannedDates[4]).toLocaleDateString('th-TH', { month: 'short', year: 'numeric' })}</div></td>
                                            <td className="px-6 py-5 text-sm font-semibold">{p.status}</td>
                                            <td className="px-6 py-5"><div className="w-24 bg-slate-100 rounded-full h-1.5 mb-1"><div className="bg-indigo-600 h-1.5 rounded-full" style={{ width: `${p.progress}%` }}></div></div><span className="text-[9px] font-bold text-slate-400 uppercase">{p.progress}% Complete</span></td>
                                            <td className="px-6 py-5 text-right"><button onClick={() => { setActiveProjectId(p.id); setActiveTab('checklist'); }} className="text-indigo-600 font-bold text-sm bg-white border px-3 py-1.5 rounded-lg hover:border-indigo-600 transition-all">Manage</button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const TimelineWidget = ({ project }) => {
                const today = new Date(), start = new Date(project.startDate), end = new Date(project.plannedDates[4]);
                if (isNaN(start) || isNaN(end)) return null;
                const total = end - start, elapsed = today - start;
                let timePct = Math.max(0, Math.min(100, (elapsed / total) * 100)), actualPct = project.progress;
                const formatDate = (d) => new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                const getGatePct = (g) => Math.max(0, Math.min(100, ((new Date(project.plannedDates[g]) - start) / total) * 100));

                return (
                    <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm mb-6 relative overflow-visible">
                        <div className="flex justify-between items-center mb-10">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-2 italic"><Clock size={16} /> Timeline Tracking</h3>
                            <div className="flex gap-4">
                                <div className="flex items-center gap-1 text-[10px] font-bold text-green-600 uppercase tracking-tighter"><div className="w-2 h-2 rounded-full bg-green-500"></div> Actual: {actualPct}%</div>
                                <div className="flex items-center gap-1 text-[10px] font-bold text-red-500 uppercase tracking-tighter"><div className="w-2 h-2 rounded-full bg-red-500"></div> Time: {Math.round(timePct)}%</div>
                                <button onClick={() => setShowTimelineAdjust(true)} className="flex items-center gap-1 text-[10px] font-bold bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full border border-indigo-100 hover:bg-indigo-100 transition-colors uppercase"><Edit size={10} /> Adjust Plan</button>
                            </div>
                        </div>
                        <div className="relative h-24 mt-2 mx-4">
                            <div className="absolute top-1/2 left-0 w-full h-2 bg-slate-100 rounded-full -translate-y-1/2"></div>
                            <div className="absolute top-1/2 left-0 h-2 bg-gradient-to-r from-green-400 to-green-500 rounded-full -translate-y-1/2 transition-all duration-1000 shadow-sm" style={{ width: `${actualPct}%` }}></div>
                            <div className="absolute top-1/2 left-0 -translate-y-1/2 -translate-x-1/2 flex flex-col items-center gap-1">
                                <div className="w-3 h-3 rounded-full bg-slate-400 border-2 border-white shadow-sm"></div><div className="text-[9px] font-bold text-slate-400 mt-4 uppercase">Start</div><div className="text-[8px] text-slate-400">{formatDate(project.startDate)}</div>
                            </div>
                            {[1, 2, 3, 4].map(g => {
                                const pct = getGatePct(g);
                                return (
                                    <div key={g} className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 flex flex-col items-center gap-1 transition-all z-10" style={{ left: `${pct}%` }}>
                                        <div className={`w-4 h-4 rounded-full border-2 border-white shadow-md transition-all duration-700 ${actualPct >= pct ? 'bg-green-500 scale-110' : 'bg-white border-slate-300'}`}></div><div className="text-[9px] font-bold mt-4">Gate {g}</div><div className="text-[8px] font-medium text-slate-500 bg-white/80 px-1 rounded border shadow-sm">{formatDate(project.plannedDates[g])}</div>
                                    </div>
                                );
                            })}
                            <div className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 flex flex-col items-center group z-20 transition-all duration-1000" style={{ left: `${timePct}%` }}>
                                <div className="bg-red-500 text-white text-[9px] font-bold px-2 py-1 rounded-md mb-1 shadow-lg shadow-red-200 whitespace-nowrap">Today</div><div className="w-0.5 h-10 bg-red-500/50"></div><div className="w-3 h-3 rounded-full bg-red-500 border-2 border-white shadow-sm -mt-1.5 animate-pulse"></div>
                            </div>
                            {actualPct > 0 && <div className="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 flex flex-col items-center group z-30 transition-all duration-1000" style={{ left: `${actualPct}%` }}><div className="absolute -top-8 bg-green-600 text-white text-[9px] font-bold px-2 py-1 rounded-md shadow-lg flex items-center gap-1 animate-bounce"><Flag size={8} /> {actualPct}%</div><div className="w-0.5 h-4 bg-green-500"></div></div>}
                        </div>
                    </div>
                );
            };

            const ChecklistView = () => {
                if (!activeProject) return null;
                const filteredItems = gateData[selectedGate].items.filter(item => activeProject.type === 'both' || item.type === 'all' || item.type === activeProject.type);
                
                const handleOpenFile = (attachment) => {
                    if (!attachment) return;
                    if (typeof attachment === 'string') { alert(`ไม่สามารถเปิดไฟล์ "${attachment}" ได้ เนื่องจากมีเพียงชื่อไฟล์ในระบบ`); }
                    else if (attachment.url) {
                        try {
                            const win = window.open();
                            if (win) { win.document.write(`<iframe src="${attachment.url}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`); win.document.title = attachment.name; }
                            else { const link = document.createElement('a'); link.href = attachment.url; link.download = attachment.name; link.click(); }
                        } catch (e) { alert("ไม่สามารถแสดงพรีวิวไฟล์ได้ในขณะนี้"); }
                    }
                };

                return (
                    <div className="max-w-5xl mx-auto space-y-6 pb-20 animate-in slide-in-from-right-4 duration-500">
                        <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="p-3 bg-indigo-50 rounded-xl text-indigo-600 shadow-inner"><FlaskConical size={24} /></div><div><h2 className="text-xl font-black text-slate-900 uppercase tracking-tight">{activeProject.name}</h2><div className="flex items-center gap-2 mt-0.5"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{activeProject.id}</span><span className="w-1 h-1 rounded-full bg-slate-300"></span><span className="text-[10px] font-bold text-indigo-600 uppercase tracking-widest">{activeProject.type} Track</span></div></div></div>
                            <button onClick={() => setActiveTab('dashboard')} className="text-slate-400 hover:text-slate-600 text-sm font-bold flex items-center gap-1 transition-colors group"><X size={16} className="group-hover:rotate-90 transition-transform"/> Close Project</button>
                        </div>
                        <TimelineWidget project={activeProject} />
                        <div className="flex gap-2">
                            {[1, 2, 3, 4].map((num) => (
                                <button key={num} onClick={() => setSelectedGate(num)} className={`flex-1 p-5 rounded-2xl border-2 transition-all text-left relative overflow-hidden group ${selectedGate === num ? 'border-indigo-600 bg-white shadow-xl -translate-y-1' : 'border-slate-100 bg-slate-50 hover:bg-white hover:border-slate-200'}`}>
                                    <div className={`text-[10px] font-black uppercase mb-1 ${selectedGate === num ? 'text-indigo-600' : 'text-slate-400'}`}>Gate {num}</div><div className={`text-sm font-bold leading-tight ${selectedGate === num ? 'text-slate-900' : 'text-slate-500'}`}>{gateData[num].title.split(':')[1]}</div>
                                    {selectedGate === num && <div className="absolute -bottom-1 -right-1 opacity-10"><CheckCircle2 size={60} className="text-indigo-600" /></div>}
                                </button>
                            ))}
                        </div>
                        <div className="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
                            <div className="p-8 border-b border-slate-100 bg-white flex justify-between items-center"><div><h3 className="text-2xl font-black text-slate-900 italic tracking-tighter uppercase">{gateData[selectedGate].title}</h3><p className="text-slate-500 text-sm mt-1 font-medium italic">{gateData[selectedGate].desc}</p></div><div className="flex gap-2"><button className="flex items-center gap-2 bg-slate-50 text-slate-600 px-5 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-100 transition-all border border-slate-200"><Save size={16} /> Save Progress</button><button className="flex items-center gap-2 bg-indigo-600 text-white px-7 py-2.5 rounded-xl text-xs font-black hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all uppercase tracking-widest">Submit Gate {selectedGate} <ArrowRight size={16} /></button></div></div>
                            <table className="w-full text-left">
                                <thead className="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-black tracking-widest border-b"><tr><th className="px-8 py-4 w-12 text-center">Status</th><th className="px-4 py-4">Requirement</th><th className="px-4 py-4 w-72">Evidence</th><th className="px-6 py-4 w-24 text-center">Attach</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredItems.map((item, idx) => {
                                        const key = `gate${selectedGate}_${idx}`, isChecked = activeProject.checklistData?.[key] || false, attachment = activeProject.attachments?.[key];
                                        const attachmentName = attachment?.name || (typeof attachment === 'string' ? attachment : "");
                                        return (
                                            <tr key={idx} className={`group hover:bg-indigo-50/30 transition-all ${item.highlight ? 'bg-amber-50/40' : ''} ${isChecked ? 'opacity-60' : ''}`}>
                                                <td className="px-8 py-6 text-center"><input type="checkbox" checked={isChecked} onChange={() => toggleCheck(selectedGate, idx)} className="w-6 h-6 rounded-lg border-2 border-slate-200 text-indigo-600 focus:ring-indigo-500 cursor-pointer transition-all hover:scale-110" /></td>
                                                <td className="px-4 py-6">
                                                    <div className={`text-base font-bold tracking-tight transition-colors ${isChecked ? 'line-through text-slate-400' : 'text-slate-800'}`}>{item.label}</div>
                                                    <div className="flex gap-2 mt-2">{item.type === 'rd' && <span className="text-[9px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-black uppercase tracking-wider">R&D Only</span>}{item.type === 'sourcing' && <span className="text-[9px] bg-cyan-100 text-cyan-700 px-2 py-0.5 rounded font-black uppercase tracking-wider">Sourcing Only</span>}{item.highlight && <span className="text-[9px] bg-red-500 text-white px-2 py-0.5 rounded font-black uppercase tracking-wider flex items-center gap-1 shadow-sm"><ShieldAlert size={10} /> Critical Control</span>}</div>
                                                </td>
                                                <td className="px-4 py-6">
                                                    {attachmentName ? (
                                                        <div className="flex items-center gap-2 text-indigo-600 hover:text-indigo-800 transition-colors cursor-pointer group/link" onClick={() => handleOpenFile(attachment)}>
                                                            <FileCheck size={18} /><span className="text-xs font-bold underline decoration-indigo-200 flex items-center gap-1">{attachmentName.length > 30 ? attachmentName.substring(0, 27) + '...' : attachmentName}{attachment?.url && <ExternalLink size={10} className="opacity-0 group-hover/link:opacity-100 transition-opacity" />}</span>
                                                        </div>
                                                    ) : (<div className="flex items-center gap-2 text-slate-300"><FileText size={18} /><span className="text-xs font-bold">{item.doc}</span></div>)}
                                                </td>
                                                <td className="px-6 py-6 text-center">
                                                    {attachmentName ? <button onClick={() => handleRemoveFile(selectedGate, idx)} className="text-red-400 hover:text-red-600 transition-colors p-2 rounded-lg hover:bg-red-50"><Trash2 size={20} /></button> : <button onClick={() => triggerFileUpload(selectedGate, idx)} className="text-slate-300 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-indigo-50"><Paperclip size={20} /></button>}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {selectedGate === 3 && <div className="m-8 p-6 bg-gradient-to-r from-amber-500 to-amber-600 rounded-3xl text-white shadow-xl relative overflow-hidden"><div className="relative z-10 flex items-start gap-4"><AlertTriangle size={24} /><div><h4 className="font-black text-lg uppercase tracking-tight">Customer Trial Restriction</h4><p className="text-sm font-medium opacity-90 mt-1">ห้ามส่งสินค้าตัวอย่างจนกว่า Critical Control ทั้งหมดจะผ่านการรับรองจาก Manager เท่านั้น</p></div></div><ShieldAlert className="absolute -right-10 -bottom-10 w-48 h-48 opacity-10 rotate-12" /></div>}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 flex selection:bg-indigo-100">
                    <Sidebar />
                    <main className="flex-1 ml-64 p-10">
                        <header className="mb-12 flex justify-between items-end">
                            <div><h1 className="text-4xl font-black text-slate-900 tracking-tighter italic uppercase leading-none">Stage-Gate Control</h1><p className="text-slate-500 font-bold mt-2 flex items-center gap-2"><span className="text-indigo-600 tracking-widest uppercase text-xs">Innovation Framework</span><span className="w-1 h-1 rounded-full bg-slate-300"></span><span>"Fail early, fail cheap, ไม่ fail ที่ลูกค้า"</span></p></div>
                            <div className="flex items-center gap-3 bg-white px-4 py-2 rounded-2xl border border-slate-200 shadow-sm"><div className="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-black text-xs shadow-inner">BZ</div><div><div className="text-sm font-black text-slate-800 leading-none">BENZ</div><div className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">System Overseer</div></div></div>
                        </header>
                        {user ? (activeTab === 'dashboard' ? <Dashboard /> : <ChecklistView />) : <LoginScreen />}
                    </main>
                    {showNewProjectModal && <NewProjectModal isOpen={showNewProjectModal} onClose={() => setShowNewProjectModal(false)} newProject={newProject} setNewProject={setNewProject} onCreate={handleCreateProject} />}
                    {showTimelineAdjust && <TimelineAdjustmentModal isOpen={showTimelineAdjust} onClose={() => setShowTimelineAdjust(false)} project={activeProject} onUpdate={handleUpdateTimeline} />}
                    <input type="file" ref={fileInputRef} className="hidden" onChange={handleFileSelected} />
                    <input type="file" ref={jsonImportRef} className="hidden" accept=".json" onChange={handleImportData} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>